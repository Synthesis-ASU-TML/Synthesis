//	twoforce1225.c////	Energy force field//	////													12.25.02 by seri////	//	inlet1 (bang)			calculate energy in each pixel and send out offset and list//	inlet1 (list)	x1 y1 x2 y2		position //	inlet2 (int)	k1		parameter1 (default: 50)//	inlet3 (int)	k2		parameter2 (default: 5)////	outlet1 (list)			pixel value list (to jit.fill)//	outlet2 (int)	py		pixel offset (to jit.fill)//////////////////////////////////////////////////////////////////////////////////////////////* starting point for a Max external object ------- *//* the required include file(s) */#include <math.h>#include "ext.h"/* structure definition of your object */typedef struct twoforce1225 {	// required header	t_object m_ob;						// example field: an outlet	void *m_out;	void *m_out_offset;		//Handle h_val;		// position	long p1x, p1y, p2x, p2y;		// parameter	long k1, k2;	long k3, k4;		// pixel value	Handle h_val;	} TwoForce1225;/* globalthat holds the class definition */void *twoforce1225_class;/* prototypes for your functions */void twoforce1225_bang(TwoForce1225 *x);void *twoforce1225_new();void twoforce1225_free(TwoForce1225 *x);void getPos(TwoForce1225 *x, t_symbol *msg, short argc, t_atom *argv);void getParam(TwoForce1225 *x, long k);void getParam2(TwoForce1225 *x, long k);void getParam3(TwoForce1225 *x, long k);void getParam4(TwoForce1225 *x, long k);void setOffsetVal(t_atom *ov, long n);/* initialization routine */void main(fptr *f){	/* tell Max about your class. */	setup((Messlist **)&twoforce1225_class, (method)twoforce1225_new, (method)twoforce1225_free,			(short)sizeof(TwoForce1225), 0L, 0);		/* bind your methods to symbols */	addbang((method)twoforce1225_bang);	addmess((method)getPos, "list", A_GIMME, 0);	addinx((method)getParam, 1);	addinx((method)getParam2, 2);	addinx((method)getParam3, 3);	addinx((method)getParam4, 4);		//post("twoforce1225 loaded..");}void getPos(TwoForce1225 *x, t_symbol *msg, short argc, t_atom *argv){	if(argc > 3 && argv[0].a_type == A_LONG && argv[1].a_type == A_LONG	   && argv[2].a_type == A_LONG && argv[3].a_type == A_LONG){		x->p1x = argv[0].a_w.w_long;		x->p1y = argv[1].a_w.w_long;		x->p2x = argv[2].a_w.w_long;		x->p2y = argv[3].a_w.w_long;				if(argc == 8 && argv[4].a_type == A_LONG && argv[5].a_type == A_LONG		   && argv[6].a_type == A_LONG && argv[7].a_type == A_LONG){			x->k1 = argv[4].a_w.w_long;			x->k2 = argv[5].a_w.w_long;			x->k3 = argv[6].a_w.w_long;			x->k4 = argv[7].a_w.w_long;		}			}}void getParam(TwoForce1225 *x, long k){	x->k1 = k;}void getParam2(TwoForce1225 *x, long k){	x->k2 = k;}void getParam3(TwoForce1225 *x, long k){	x->k3 = k;}void getParam4(TwoForce1225 *x, long k){	x->k4 = k;}long sqrt2(long f, int k3, int k4){	long next = f, current;	int i;		if(f == 0|| k3 < 0 || k4 < 0) return f;	for(i=0; i<k3; i++){		current = next;		next = (current + f / current) >> k4;				if(next == current) break;	}	return next;}long distance(int x1, int y1, int x2, int y2, int k3, int k4){	//return (long)sqrt(pow(x2-x1, 2) + pow(y2-y1, 2));	//return (pow(x2-x1, 2) + pow(y2-y1, 2));	int dx = x2 - x1;	int dy = y2 - y1;	return sqrt2(dx*dx + dy*dy, k3, k4);}void setOffsetVal(t_atom *ov, long n){	int i, j;	j = n / 320;	i = n - j * 320;	SETLONG(&ov[0], i);	SETLONG(&ov[1], j); }void twoforce1225_bang(TwoForce1225 *x){	int i,j;	int index = 0;	long d1, d2, dp;	t_atom ov[2];	long energy;	long value;	long dd;		// pointer to the array of long for previous value	t_atom *pv = (t_atom *)*x->h_val;		for(j=0; j<240; j++){		for(i=0; i<320; i++, index++){			// calc distance from pixel to each person			d1 = distance(i, j, x->p1x, x->p1y, x->k3, x->k4);			d2 = distance(i, j, x->p2x, x->p2y, x->k3, x->k4);			dp = distance(x->p1x, x->p1y, x->p2x, x->p2y, x->k3, x->k4);				// calc energy			dd = (d1 + d2 - dp + x->k2);			energy = x->k1*10/dd;						// clip & invert (0 is the highest energy)			if(energy > 65535) energy = 65535;			else if(energy < 0) energy = 0;						// output new value only when the value has changed			SETLONG(&pv[index], energy);			//SETLONG(&pv[index], j*255/240);		}	}			// offset value and pixel value (0-32766, 32767-65533, 65534-76800)	setOffsetVal(ov, 0);	outlet_list(x->m_out_offset, 0L, 2, ov);	outlet_list(x->m_out, 0L, 32767, pv);		setOffsetVal(ov, 32767);	outlet_list(x->m_out_offset, 0L, 2, ov);	outlet_list(x->m_out, 0L, 32767, pv+32767);		setOffsetVal(ov, 65534);	outlet_list(x->m_out_offset, 0L, 2, ov);	outlet_list(x->m_out, 0L, 11266, pv+65534);	}//// instance creation routine//void *twoforce1225_new(){	TwoForce1225 *x;	t_atom *pv;	int i;	long pixelsize;		// create an instance	x = newobject(twoforce1225_class);		// allocate pixel memory	pixelsize = 320 * 240;	x->h_val = newhandle(sizeof(t_atom) * pixelsize); 	pv = (t_atom *)*x->h_val;	for(i=0; i<pixelsize; i++) SETLONG(&pv[i], 0);	// initialization	x->k1 = 50;	x->k2 = 5;		x->k3 = 1;	x->k4 = 1;		// crate inlet	intin(x, 4);	intin(x, 3);	intin(x, 2);	intin(x, 1);		// create outlet	x->m_out_offset = intout(x);	x->m_out = listout(x);						return (x);							// return newly created object to caller}void twoforce1225_free(TwoForce1225 *x){	disposhandle(x->h_val);}